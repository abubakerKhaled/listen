#!/bin/bash
# AppRun - Entry point for the Listen AppImage

# Get the directory where this script is located
APPDIR="$(dirname "$(readlink -f "$0")")"

# Detect Python version
PYTHON_VERSION=$(ls "${APPDIR}/usr/lib/" | grep -E '^python[0-9]+\.[0-9]+$' | head -1)
PYTHON_LIB="${APPDIR}/usr/lib/${PYTHON_VERSION}"

# Set up environment
export PATH="${APPDIR}/usr/bin:${PATH}"
export LD_LIBRARY_PATH="${APPDIR}/usr/lib:${APPDIR}/usr/lib/x86_64-linux-gnu:${LD_LIBRARY_PATH}"
export PYTHONHOME="${APPDIR}/usr"

# CRITICAL: Set PYTHONPATH with site-packages FIRST to find our app, then stdlib
export PYTHONPATH="${PYTHON_LIB}/site-packages:${PYTHON_LIB}:${PYTHON_LIB}/lib-dynload"

# Don't look at user site-packages
export PYTHONNOUSERSITE=1

# Set XDG directories for model caching (uses ~/.cache by default)
export XDG_CACHE_HOME="${XDG_CACHE_HOME:-$HOME/.cache}"

# Set GI_TYPELIB_PATH for GTK4/Adwaita (PyGObject)
export GI_TYPELIB_PATH="${APPDIR}/usr/lib/girepository-1.0:${GI_TYPELIB_PATH}"

# Run the application
exec "${APPDIR}/usr/bin/python3" -m listen_app.cli "$@"
